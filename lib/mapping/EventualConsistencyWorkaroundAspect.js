"use strict";
/**
 * Copyright (c) HashiCorp, Inc.
 * SPDX-License-Identifier: MPL-2.0
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.EventualConsistencyWorkaroundAspect = void 0;
const cdktf_1 = require("cdktf");
const _tokens_1 = require("cdktf/lib/_tokens");
const resolve_1 = require("cdktf/lib/tokens/private/resolve");
const cloudcontrolapi_resource_1 = require("../aws/cloudcontrolapi-resource");
const provider_1 = require("../time/provider");
const sleep_1 = require("../time/sleep");
/**
 * This Aspect serves as a workaround for eventually consistent resources (e.g. IAM resources)
 * It has to be added to the root (i.e. the Terraform Stack) so that it is invoked
 * on all resources that might reference the `eventualConsistentTarget` which is passed when
 * instantiating an `EventualConsistencyWorkaroundAspect`.
 *
 * How does it work?
 * - The `visit` function will be invoked for every resource in e.g. the TerraformStack
 * - Whenever a visited resource contains a reference to a property of the `eventualConsistentTarget`
 *   a `time_sleep` resource will be added as a dependency for that resource
 * - The `time_sleep` resource itself depends on the `eventualConsistentTarget` and by default waits
 *   20 seconds after the `eventualConsistentTarget` was created until it marks itself as done
 * - The dependend resources will then have their dependency on `time_sleep` fullfilled and will start
 *   to deploy
 */
class EventualConsistencyWorkaroundAspect {
    // The CDK for Terraform currently requires providers to be configured even if they don't have
    // any config. As we cannot know whether the stack already contains a time provider, we create
    // an aliased one for usage within this Aspect
    static getTimeProvider(stack) {
        if (!EventualConsistencyWorkaroundAspect.stackTimeProviders.has(stack.node.id)) {
            EventualConsistencyWorkaroundAspect.stackTimeProviders.set(stack.node.id, new provider_1.TimeProvider(stack, "eventual_consistency_workaround_aspect", {
                alias: `awsadapter_eventual_consistency_workaround_aspect_${stack.node.id}`,
            }));
        }
        return EventualConsistencyWorkaroundAspect.stackTimeProviders.get(stack.node.id);
    }
    constructor(eventualConsistentTarget, options = {
        createDurationSeconds: 20,
        destroyDurationSeconds: 0,
    }) {
        this.eventualConsistentTarget = eventualConsistentTarget;
        this.options = options;
    }
    visit(node) {
        if (node instanceof cdktf_1.TerraformResource &&
            node instanceof cloudcontrolapi_resource_1.CloudcontrolapiResource &&
            dependsOn(node, this.eventualConsistentTarget)) {
            if (!node.dependsOn) {
                node.dependsOn = [];
            }
            node.dependsOn.push((0, cdktf_1.dependable)(this.getSleepResource()));
        }
    }
    /**
     * makes sure we reuse the same sleep resource for the same eventual consistent target
     * (aka for an instance of this class)
     */
    getSleepResource() {
        if (!this.sleepResource) {
            this.sleepResource = new sleep_1.Sleep(this.eventualConsistentTarget, `sleep_${this.eventualConsistentTarget.node.id}`, {
                createDuration: `${this.options.createDurationSeconds}s`,
                destroyDuration: `${this.options.destroyDurationSeconds}s`,
                dependsOn: [this.eventualConsistentTarget],
                provider: EventualConsistencyWorkaroundAspect.getTimeProvider(cdktf_1.TerraformStack.of(this.eventualConsistentTarget)),
            });
        }
        return this.sleepResource;
    }
}
exports.EventualConsistencyWorkaroundAspect = EventualConsistencyWorkaroundAspect;
EventualConsistencyWorkaroundAspect.stackTimeProviders = new Map();
/**
 * returns true if source contains a property that depends on target
 */
function dependsOn(source, target) {
    const tokens = (0, resolve_1.findTokens)(cdktf_1.TerraformStack.of(source), () => source.toTerraform());
    // Checks if there's at least one token that resolves to an Terraform reference
    // which references the target
    // e.g. resolved could be "${aws_iam_role.typescriptcronlambda_adapter_lambdaServiceRole494E4CA6_233C76C0.arn}"
    // which includes the target "aws_iam_role.typescriptcronlambda_adapter_lambdaServiceRole494E4CA6_233C76C0"
    return tokens.some((token) => {
        const resolved = (0, _tokens_1.resolve)(cdktf_1.TerraformStack.of(source), token);
        const resolvedFqn = (0, _tokens_1.resolve)(cdktf_1.TerraformStack.of(source), target.fqn); // still wrapped in "${}"
        const resolvedFqnRaw = typeof resolvedFqn === "string"
            ? resolvedFqn.replace(/^\$\{/, "").replace(/\}$/, "")
            : resolvedFqn;
        return typeof resolved === "string" && resolved.includes(resolvedFqnRaw);
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRXZlbnR1YWxDb25zaXN0ZW5jeVdvcmthcm91bmRBc3BlY3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbWFwcGluZy9FdmVudHVhbENvbnNpc3RlbmN5V29ya2Fyb3VuZEFzcGVjdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7OztHQUdHOzs7QUFFSCxpQ0FBK0U7QUFDL0UsK0NBQTRDO0FBQzVDLDhEQUE4RDtBQUU5RCw4RUFBMEU7QUFDMUUsK0NBQWdEO0FBQ2hELHlDQUFzQztBQU90Qzs7Ozs7Ozs7Ozs7Ozs7R0FjRztBQUNILE1BQWEsbUNBQW1DO0lBRzlDLDhGQUE4RjtJQUM5Riw4RkFBOEY7SUFDOUYsOENBQThDO0lBQ3RDLE1BQU0sQ0FBQyxlQUFlLENBQUMsS0FBcUI7UUFDbEQsSUFDRSxDQUFDLG1DQUFtQyxDQUFDLGtCQUFrQixDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUMxRSxDQUFDO1lBQ0QsbUNBQW1DLENBQUMsa0JBQWtCLENBQUMsR0FBRyxDQUN4RCxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFDYixJQUFJLHVCQUFZLENBQUMsS0FBSyxFQUFFLHdDQUF3QyxFQUFFO2dCQUNoRSxLQUFLLEVBQUUscURBQXFELEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFO2FBQzVFLENBQUMsQ0FDSCxDQUFDO1FBQ0osQ0FBQztRQUNELE9BQU8sbUNBQW1DLENBQUMsa0JBQWtCLENBQUMsR0FBRyxDQUMvRCxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FDYixDQUFDO0lBQ0wsQ0FBQztJQUlELFlBQ1Usd0JBQTJDLEVBQzNDLFVBQXNEO1FBQzVELHFCQUFxQixFQUFFLEVBQUU7UUFDekIsc0JBQXNCLEVBQUUsQ0FBQztLQUMxQjtRQUpPLDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBbUI7UUFDM0MsWUFBTyxHQUFQLE9BQU8sQ0FHZDtJQUNBLENBQUM7SUFFSixLQUFLLENBQUMsSUFBZ0I7UUFDcEIsSUFDRSxJQUFJLFlBQVkseUJBQWlCO1lBQ2pDLElBQUksWUFBWSxrREFBdUI7WUFDdkMsU0FBUyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsd0JBQXdCLENBQUMsRUFDOUMsQ0FBQztZQUNELElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7Z0JBQ3BCLElBQUksQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDO1lBQ3RCLENBQUM7WUFDRCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFBLGtCQUFVLEVBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQzNELENBQUM7SUFDSCxDQUFDO0lBRUQ7OztPQUdHO0lBQ0ssZ0JBQWdCO1FBQ3RCLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDeEIsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLGFBQUssQ0FDNUIsSUFBSSxDQUFDLHdCQUF3QixFQUM3QixTQUFTLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLEVBQ2hEO2dCQUNFLGNBQWMsRUFBRSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMscUJBQXFCLEdBQUc7Z0JBQ3hELGVBQWUsRUFBRSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsc0JBQXNCLEdBQUc7Z0JBQzFELFNBQVMsRUFBRSxDQUFDLElBQUksQ0FBQyx3QkFBd0IsQ0FBQztnQkFDMUMsUUFBUSxFQUFFLG1DQUFtQyxDQUFDLGVBQWUsQ0FDM0Qsc0JBQWMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLHdCQUF3QixDQUFDLENBQ2pEO2FBQ0YsQ0FDRixDQUFDO1FBQ0osQ0FBQztRQUNELE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQztJQUM1QixDQUFDOztBQWpFSCxrRkFrRUM7QUFqRWdCLHNEQUFrQixHQUFHLElBQUksR0FBRyxFQUF3QixDQUFDO0FBbUV0RTs7R0FFRztBQUNILFNBQVMsU0FBUyxDQUNoQixNQUF5QixFQUN6QixNQUF5QjtJQUV6QixNQUFNLE1BQU0sR0FBRyxJQUFBLG9CQUFVLEVBQUMsc0JBQWMsQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQ3hELE1BQU0sQ0FBQyxXQUFXLEVBQUUsQ0FDckIsQ0FBQztJQUVGLCtFQUErRTtJQUMvRSw4QkFBOEI7SUFDOUIsK0dBQStHO0lBQy9HLDJHQUEyRztJQUMzRyxPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTtRQUMzQixNQUFNLFFBQVEsR0FBRyxJQUFBLGlCQUFPLEVBQUMsc0JBQWMsQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLEVBQUUsS0FBSyxDQUFRLENBQUM7UUFDbEUsTUFBTSxXQUFXLEdBQUcsSUFBQSxpQkFBTyxFQUFDLHNCQUFjLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxFQUFFLE1BQU0sQ0FBQyxHQUFHLENBQVEsQ0FBQyxDQUFDLHlCQUF5QjtRQUNwRyxNQUFNLGNBQWMsR0FDbEIsT0FBTyxXQUFXLEtBQUssUUFBUTtZQUM3QixDQUFDLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUM7WUFDckQsQ0FBQyxDQUFDLFdBQVcsQ0FBQztRQUNsQixPQUFPLE9BQU8sUUFBUSxLQUFLLFFBQVEsSUFBSSxRQUFRLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxDQUFDO0lBQzNFLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IChjKSBIYXNoaUNvcnAsIEluYy5cbiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBNUEwtMi4wXG4gKi9cblxuaW1wb3J0IHsgZGVwZW5kYWJsZSwgSUFzcGVjdCwgVGVycmFmb3JtUmVzb3VyY2UsIFRlcnJhZm9ybVN0YWNrIH0gZnJvbSBcImNka3RmXCI7XG5pbXBvcnQgeyByZXNvbHZlIH0gZnJvbSBcImNka3RmL2xpYi9fdG9rZW5zXCI7XG5pbXBvcnQgeyBmaW5kVG9rZW5zIH0gZnJvbSBcImNka3RmL2xpYi90b2tlbnMvcHJpdmF0ZS9yZXNvbHZlXCI7XG5pbXBvcnQgeyBJQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCB7IENsb3VkY29udHJvbGFwaVJlc291cmNlIH0gZnJvbSBcIi4uL2F3cy9jbG91ZGNvbnRyb2xhcGktcmVzb3VyY2VcIjtcbmltcG9ydCB7IFRpbWVQcm92aWRlciB9IGZyb20gXCIuLi90aW1lL3Byb3ZpZGVyXCI7XG5pbXBvcnQgeyBTbGVlcCB9IGZyb20gXCIuLi90aW1lL3NsZWVwXCI7XG5cbmludGVyZmFjZSBFdmVudHVhbENvbnNpc3RlbmN5V29ya2Fyb3VuZEFzcGVjdE9wdGlvbnMge1xuICBjcmVhdGVEdXJhdGlvblNlY29uZHM6IG51bWJlcjtcbiAgZGVzdHJveUR1cmF0aW9uU2Vjb25kczogbnVtYmVyO1xufVxuXG4vKipcbiAqIFRoaXMgQXNwZWN0IHNlcnZlcyBhcyBhIHdvcmthcm91bmQgZm9yIGV2ZW50dWFsbHkgY29uc2lzdGVudCByZXNvdXJjZXMgKGUuZy4gSUFNIHJlc291cmNlcylcbiAqIEl0IGhhcyB0byBiZSBhZGRlZCB0byB0aGUgcm9vdCAoaS5lLiB0aGUgVGVycmFmb3JtIFN0YWNrKSBzbyB0aGF0IGl0IGlzIGludm9rZWRcbiAqIG9uIGFsbCByZXNvdXJjZXMgdGhhdCBtaWdodCByZWZlcmVuY2UgdGhlIGBldmVudHVhbENvbnNpc3RlbnRUYXJnZXRgIHdoaWNoIGlzIHBhc3NlZCB3aGVuXG4gKiBpbnN0YW50aWF0aW5nIGFuIGBFdmVudHVhbENvbnNpc3RlbmN5V29ya2Fyb3VuZEFzcGVjdGAuXG4gKlxuICogSG93IGRvZXMgaXQgd29yaz9cbiAqIC0gVGhlIGB2aXNpdGAgZnVuY3Rpb24gd2lsbCBiZSBpbnZva2VkIGZvciBldmVyeSByZXNvdXJjZSBpbiBlLmcuIHRoZSBUZXJyYWZvcm1TdGFja1xuICogLSBXaGVuZXZlciBhIHZpc2l0ZWQgcmVzb3VyY2UgY29udGFpbnMgYSByZWZlcmVuY2UgdG8gYSBwcm9wZXJ0eSBvZiB0aGUgYGV2ZW50dWFsQ29uc2lzdGVudFRhcmdldGBcbiAqICAgYSBgdGltZV9zbGVlcGAgcmVzb3VyY2Ugd2lsbCBiZSBhZGRlZCBhcyBhIGRlcGVuZGVuY3kgZm9yIHRoYXQgcmVzb3VyY2VcbiAqIC0gVGhlIGB0aW1lX3NsZWVwYCByZXNvdXJjZSBpdHNlbGYgZGVwZW5kcyBvbiB0aGUgYGV2ZW50dWFsQ29uc2lzdGVudFRhcmdldGAgYW5kIGJ5IGRlZmF1bHQgd2FpdHNcbiAqICAgMjAgc2Vjb25kcyBhZnRlciB0aGUgYGV2ZW50dWFsQ29uc2lzdGVudFRhcmdldGAgd2FzIGNyZWF0ZWQgdW50aWwgaXQgbWFya3MgaXRzZWxmIGFzIGRvbmVcbiAqIC0gVGhlIGRlcGVuZGVuZCByZXNvdXJjZXMgd2lsbCB0aGVuIGhhdmUgdGhlaXIgZGVwZW5kZW5jeSBvbiBgdGltZV9zbGVlcGAgZnVsbGZpbGxlZCBhbmQgd2lsbCBzdGFydFxuICogICB0byBkZXBsb3lcbiAqL1xuZXhwb3J0IGNsYXNzIEV2ZW50dWFsQ29uc2lzdGVuY3lXb3JrYXJvdW5kQXNwZWN0IGltcGxlbWVudHMgSUFzcGVjdCB7XG4gIHByaXZhdGUgc3RhdGljIHN0YWNrVGltZVByb3ZpZGVycyA9IG5ldyBNYXA8c3RyaW5nLCBUaW1lUHJvdmlkZXI+KCk7XG5cbiAgLy8gVGhlIENESyBmb3IgVGVycmFmb3JtIGN1cnJlbnRseSByZXF1aXJlcyBwcm92aWRlcnMgdG8gYmUgY29uZmlndXJlZCBldmVuIGlmIHRoZXkgZG9uJ3QgaGF2ZVxuICAvLyBhbnkgY29uZmlnLiBBcyB3ZSBjYW5ub3Qga25vdyB3aGV0aGVyIHRoZSBzdGFjayBhbHJlYWR5IGNvbnRhaW5zIGEgdGltZSBwcm92aWRlciwgd2UgY3JlYXRlXG4gIC8vIGFuIGFsaWFzZWQgb25lIGZvciB1c2FnZSB3aXRoaW4gdGhpcyBBc3BlY3RcbiAgcHJpdmF0ZSBzdGF0aWMgZ2V0VGltZVByb3ZpZGVyKHN0YWNrOiBUZXJyYWZvcm1TdGFjayk6IFRpbWVQcm92aWRlciB7XG4gICAgaWYgKFxuICAgICAgIUV2ZW50dWFsQ29uc2lzdGVuY3lXb3JrYXJvdW5kQXNwZWN0LnN0YWNrVGltZVByb3ZpZGVycy5oYXMoc3RhY2subm9kZS5pZClcbiAgICApIHtcbiAgICAgIEV2ZW50dWFsQ29uc2lzdGVuY3lXb3JrYXJvdW5kQXNwZWN0LnN0YWNrVGltZVByb3ZpZGVycy5zZXQoXG4gICAgICAgIHN0YWNrLm5vZGUuaWQsXG4gICAgICAgIG5ldyBUaW1lUHJvdmlkZXIoc3RhY2ssIFwiZXZlbnR1YWxfY29uc2lzdGVuY3lfd29ya2Fyb3VuZF9hc3BlY3RcIiwge1xuICAgICAgICAgIGFsaWFzOiBgYXdzYWRhcHRlcl9ldmVudHVhbF9jb25zaXN0ZW5jeV93b3JrYXJvdW5kX2FzcGVjdF8ke3N0YWNrLm5vZGUuaWR9YCxcbiAgICAgICAgfSksXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gRXZlbnR1YWxDb25zaXN0ZW5jeVdvcmthcm91bmRBc3BlY3Quc3RhY2tUaW1lUHJvdmlkZXJzLmdldChcbiAgICAgIHN0YWNrLm5vZGUuaWQsXG4gICAgKSE7XG4gIH1cblxuICBwcml2YXRlIHNsZWVwUmVzb3VyY2U/OiBTbGVlcDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGV2ZW50dWFsQ29uc2lzdGVudFRhcmdldDogVGVycmFmb3JtUmVzb3VyY2UsXG4gICAgcHJpdmF0ZSBvcHRpb25zOiBFdmVudHVhbENvbnNpc3RlbmN5V29ya2Fyb3VuZEFzcGVjdE9wdGlvbnMgPSB7XG4gICAgICBjcmVhdGVEdXJhdGlvblNlY29uZHM6IDIwLFxuICAgICAgZGVzdHJveUR1cmF0aW9uU2Vjb25kczogMCxcbiAgICB9LFxuICApIHt9XG5cbiAgdmlzaXQobm9kZTogSUNvbnN0cnVjdCkge1xuICAgIGlmIChcbiAgICAgIG5vZGUgaW5zdGFuY2VvZiBUZXJyYWZvcm1SZXNvdXJjZSAmJlxuICAgICAgbm9kZSBpbnN0YW5jZW9mIENsb3VkY29udHJvbGFwaVJlc291cmNlICYmXG4gICAgICBkZXBlbmRzT24obm9kZSwgdGhpcy5ldmVudHVhbENvbnNpc3RlbnRUYXJnZXQpXG4gICAgKSB7XG4gICAgICBpZiAoIW5vZGUuZGVwZW5kc09uKSB7XG4gICAgICAgIG5vZGUuZGVwZW5kc09uID0gW107XG4gICAgICB9XG4gICAgICBub2RlLmRlcGVuZHNPbi5wdXNoKGRlcGVuZGFibGUodGhpcy5nZXRTbGVlcFJlc291cmNlKCkpKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogbWFrZXMgc3VyZSB3ZSByZXVzZSB0aGUgc2FtZSBzbGVlcCByZXNvdXJjZSBmb3IgdGhlIHNhbWUgZXZlbnR1YWwgY29uc2lzdGVudCB0YXJnZXRcbiAgICogKGFrYSBmb3IgYW4gaW5zdGFuY2Ugb2YgdGhpcyBjbGFzcylcbiAgICovXG4gIHByaXZhdGUgZ2V0U2xlZXBSZXNvdXJjZSgpOiBTbGVlcCB7XG4gICAgaWYgKCF0aGlzLnNsZWVwUmVzb3VyY2UpIHtcbiAgICAgIHRoaXMuc2xlZXBSZXNvdXJjZSA9IG5ldyBTbGVlcChcbiAgICAgICAgdGhpcy5ldmVudHVhbENvbnNpc3RlbnRUYXJnZXQsXG4gICAgICAgIGBzbGVlcF8ke3RoaXMuZXZlbnR1YWxDb25zaXN0ZW50VGFyZ2V0Lm5vZGUuaWR9YCxcbiAgICAgICAge1xuICAgICAgICAgIGNyZWF0ZUR1cmF0aW9uOiBgJHt0aGlzLm9wdGlvbnMuY3JlYXRlRHVyYXRpb25TZWNvbmRzfXNgLFxuICAgICAgICAgIGRlc3Ryb3lEdXJhdGlvbjogYCR7dGhpcy5vcHRpb25zLmRlc3Ryb3lEdXJhdGlvblNlY29uZHN9c2AsXG4gICAgICAgICAgZGVwZW5kc09uOiBbdGhpcy5ldmVudHVhbENvbnNpc3RlbnRUYXJnZXRdLFxuICAgICAgICAgIHByb3ZpZGVyOiBFdmVudHVhbENvbnNpc3RlbmN5V29ya2Fyb3VuZEFzcGVjdC5nZXRUaW1lUHJvdmlkZXIoXG4gICAgICAgICAgICBUZXJyYWZvcm1TdGFjay5vZih0aGlzLmV2ZW50dWFsQ29uc2lzdGVudFRhcmdldCksXG4gICAgICAgICAgKSxcbiAgICAgICAgfSxcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnNsZWVwUmVzb3VyY2U7XG4gIH1cbn1cblxuLyoqXG4gKiByZXR1cm5zIHRydWUgaWYgc291cmNlIGNvbnRhaW5zIGEgcHJvcGVydHkgdGhhdCBkZXBlbmRzIG9uIHRhcmdldFxuICovXG5mdW5jdGlvbiBkZXBlbmRzT24oXG4gIHNvdXJjZTogVGVycmFmb3JtUmVzb3VyY2UsXG4gIHRhcmdldDogVGVycmFmb3JtUmVzb3VyY2UsXG4pOiBib29sZWFuIHtcbiAgY29uc3QgdG9rZW5zID0gZmluZFRva2VucyhUZXJyYWZvcm1TdGFjay5vZihzb3VyY2UpLCAoKSA9PlxuICAgIHNvdXJjZS50b1RlcnJhZm9ybSgpLFxuICApO1xuXG4gIC8vIENoZWNrcyBpZiB0aGVyZSdzIGF0IGxlYXN0IG9uZSB0b2tlbiB0aGF0IHJlc29sdmVzIHRvIGFuIFRlcnJhZm9ybSByZWZlcmVuY2VcbiAgLy8gd2hpY2ggcmVmZXJlbmNlcyB0aGUgdGFyZ2V0XG4gIC8vIGUuZy4gcmVzb2x2ZWQgY291bGQgYmUgXCIke2F3c19pYW1fcm9sZS50eXBlc2NyaXB0Y3JvbmxhbWJkYV9hZGFwdGVyX2xhbWJkYVNlcnZpY2VSb2xlNDk0RTRDQTZfMjMzQzc2QzAuYXJufVwiXG4gIC8vIHdoaWNoIGluY2x1ZGVzIHRoZSB0YXJnZXQgXCJhd3NfaWFtX3JvbGUudHlwZXNjcmlwdGNyb25sYW1iZGFfYWRhcHRlcl9sYW1iZGFTZXJ2aWNlUm9sZTQ5NEU0Q0E2XzIzM0M3NkMwXCJcbiAgcmV0dXJuIHRva2Vucy5zb21lKCh0b2tlbikgPT4ge1xuICAgIGNvbnN0IHJlc29sdmVkID0gcmVzb2x2ZShUZXJyYWZvcm1TdGFjay5vZihzb3VyY2UpLCB0b2tlbikgYXMgYW55O1xuICAgIGNvbnN0IHJlc29sdmVkRnFuID0gcmVzb2x2ZShUZXJyYWZvcm1TdGFjay5vZihzb3VyY2UpLCB0YXJnZXQuZnFuKSBhcyBhbnk7IC8vIHN0aWxsIHdyYXBwZWQgaW4gXCIke31cIlxuICAgIGNvbnN0IHJlc29sdmVkRnFuUmF3ID1cbiAgICAgIHR5cGVvZiByZXNvbHZlZEZxbiA9PT0gXCJzdHJpbmdcIlxuICAgICAgICA/IHJlc29sdmVkRnFuLnJlcGxhY2UoL15cXCRcXHsvLCBcIlwiKS5yZXBsYWNlKC9cXH0kLywgXCJcIilcbiAgICAgICAgOiByZXNvbHZlZEZxbjtcbiAgICByZXR1cm4gdHlwZW9mIHJlc29sdmVkID09PSBcInN0cmluZ1wiICYmIHJlc29sdmVkLmluY2x1ZGVzKHJlc29sdmVkRnFuUmF3KTtcbiAgfSk7XG59XG4iXX0=