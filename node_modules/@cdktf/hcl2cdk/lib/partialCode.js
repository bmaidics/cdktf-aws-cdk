"use strict";
/**
 * Copyright (c) HashiCorp, Inc.
 * SPDX-License-Identifier: MPL-2.0
 */
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getRequiredAttributes = exports.fillWithConfigAccessors = void 0;
const terraformSchema_1 = require("./terraformSchema");
const t = __importStar(require("@babel/types"));
const utils_1 = require("./utils");
function getConfigFieldName(topLevelConfig, name) {
    const sanitizedName = (0, utils_1.camelCase)(name);
    return deduplicateName(Object.keys(topLevelConfig), sanitizedName);
}
function deduplicateName(existingNames, name) {
    let newName = name;
    let i = 1;
    while (existingNames.includes(newName)) {
        newName = `${name}${i}`;
        i++;
    }
    return newName;
}
function fillWithConfigAccessors(scope, config, path) {
    if (Array.isArray(config)) {
        return config.map((c) => fillWithConfigAccessors(scope, c, `${path}.[]`));
    }
    if (typeof config === "object" && config !== null) {
        const mutated = Object.entries(config).reduce((acc, [key, value]) => ({
            ...acc,
            [key]: fillWithConfigAccessors(scope, value, `${path}.${key}`),
        }), {});
        // Get type of this part of the config
        const attributeType = (0, terraformSchema_1.getTypeAtPath)(scope.providerSchema, path);
        const requiredAttributes = getRequiredAttributes(attributeType);
        // Add accessors for all required attributes that are missing
        requiredAttributes.forEach((key) => {
            const value = mutated[key];
            const isNotDirectlyAccessible = value === undefined;
            const isReplacedByAst = t.isExpression(mutated) || t.isExpression(value);
            const isEmptyArray = Array.isArray(value) && value.length === 0;
            // If this was already replaced by an AST node, we don't need to do anything
            // We assume all fields are filled in by the AST
            if (isReplacedByAst) {
                return;
            }
            if (isNotDirectlyAccessible || isEmptyArray) {
                const fieldName = getConfigFieldName(scope.topLevelConfig, key);
                mutated[key] = t.memberExpression(t.identifier("config"), t.identifier(fieldName));
                scope.topLevelConfig[fieldName] = `${path}.${key}`;
            }
        });
        return mutated;
    }
    else {
        return config;
    }
}
exports.fillWithConfigAccessors = fillWithConfigAccessors;
function getRequiredAttributes(attributeType) {
    if (!attributeType) {
        return [];
    }
    if (typeof attributeType !== "object" ||
        Array.isArray(attributeType) ||
        attributeType === null ||
        attributeType === undefined ||
        !("block" in attributeType)) {
        return [];
    }
    const requiredAttributes = Object.entries(attributeType.block.attributes || {}).reduce((acc, [key, value]) => (value.required ? [...acc, key] : acc), []);
    // Logic taken from (and should be shared with) provider generator resource parser: attributeForBlockType
    const requiredBlockTypes = Object.entries(attributeType.block.block_types || {}).reduce((acc, [key, value]) => {
        if (value.nesting_mode === "single" &&
            !Object.values(value.block.attributes || {}).some((x) => !x.required)) {
            return [...acc, key];
        }
        if (value.nesting_mode === "map") {
            return acc;
        }
        if ((value.nesting_mode === "list" || value.nesting_mode === "set") &&
            value.min_items === undefined
            ? false
            : value.min_items > 0) {
            return [...acc, key];
        }
        return acc;
    }, []);
    return [...requiredAttributes, ...requiredBlockTypes].sort();
}
exports.getRequiredAttributes = getRequiredAttributes;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFydGlhbENvZGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJwYXJ0aWFsQ29kZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7OztHQUdHOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVILHVEQUFrRDtBQUVsRCxnREFBa0M7QUFDbEMsbUNBQW9DO0FBRXBDLFNBQVMsa0JBQWtCLENBQ3pCLGNBQXVDLEVBQ3ZDLElBQVk7SUFFWixNQUFNLGFBQWEsR0FBRyxJQUFBLGlCQUFTLEVBQUMsSUFBSSxDQUFDLENBQUM7SUFDdEMsT0FBTyxlQUFlLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsRUFBRSxhQUFhLENBQUMsQ0FBQztBQUNyRSxDQUFDO0FBRUQsU0FBUyxlQUFlLENBQUMsYUFBdUIsRUFBRSxJQUFZO0lBQzVELElBQUksT0FBTyxHQUFHLElBQUksQ0FBQztJQUNuQixJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDVixPQUFPLGFBQWEsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUU7UUFDdEMsT0FBTyxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsRUFBRSxDQUFDO1FBQ3hCLENBQUMsRUFBRSxDQUFDO0tBQ0w7SUFDRCxPQUFPLE9BQU8sQ0FBQztBQUNqQixDQUFDO0FBRUQsU0FBZ0IsdUJBQXVCLENBQ3JDLEtBQW9CLEVBQ3BCLE1BQThCLEVBQzlCLElBQVk7SUFFWixJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUU7UUFDekIsT0FBTyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyx1QkFBdUIsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxFQUFFLEdBQUcsSUFBSSxLQUFLLENBQUMsQ0FBQyxDQUFDO0tBQzNFO0lBRUQsSUFBSSxPQUFPLE1BQU0sS0FBSyxRQUFRLElBQUksTUFBTSxLQUFLLElBQUksRUFBRTtRQUNqRCxNQUFNLE9BQU8sR0FBRyxN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TUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxFQUFFLEVBQUU7UUFDN0IsSUFDRSxLQUFLLENBQUMsWUFBWSxLQUFLLFFBQVE7WUFDL0IsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsVUFBVSxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLEVBQ3JFO1lBQ0EsT0FBTyxDQUFDLEdBQUcsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1NBQ3RCO1FBQ0QsSUFBSSxLQUFLLENBQUMsWUFBWSxLQUFLLEtBQUssRUFBRTtZQUNoQyxPQUFPLEdBQUcsQ0FBQztTQUNaO1FBRUQsSUFDRSxDQUFDLEtBQUssQ0FBQyxZQUFZLEtBQUssTUFBTSxJQUFJLEtBQUssQ0FBQyxZQUFZLEtBQUssS0FBSyxDQUFDO1lBQy9ELEtBQUssQ0FBQyxTQUFTLEtBQUssU0FBUztZQUMzQixDQUFDLENBQUMsS0FBSztZQUNQLENBQUMsQ0FBRSxLQUFhLENBQUMsU0FBUyxHQUFHLENBQUMsRUFDaEM7WUFDQSxPQUFPLENBQUMsR0FBRyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7U0FDdEI7UUFFRCxPQUFPLEdBQUcsQ0FBQztJQUNiLENBQUMsRUFBRSxFQUFjLENBQUMsQ0FBQztJQUNuQixPQUFPLENBQUMsR0FBRyxrQkFBa0IsRUFBRSxHQUFHLGtCQUFrQixDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7QUFDL0QsQ0FBQztBQWpERCxzREFpREMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAoYykgSGFzaGlDb3JwLCBJbmMuXG4gKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogTVBMLTIuMFxuICovXG5cbmltcG9ydCB7IGdldFR5cGVBdFBhdGggfSBmcm9tIFwiLi90ZXJyYWZvcm1TY2hlbWFcIjtcbmltcG9ydCB7IFJlc291cmNlU2NvcGUsIFRlcnJhZm9ybVJlc291cmNlQmxvY2sgfSBmcm9tIFwiLi90eXBlc1wiO1xuaW1wb3J0ICogYXMgdCBmcm9tIFwiQGJhYmVsL3R5cGVzXCI7XG5pbXBvcnQgeyBjYW1lbENhc2UgfSBmcm9tIFwiLi91dGlsc1wiO1xuXG5mdW5jdGlvbiBnZXRDb25maWdGaWVsZE5hbWUoXG4gIHRvcExldmVsQ29uZmlnOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPixcbiAgbmFtZTogc3RyaW5nXG4pIHtcbiAgY29uc3Qgc2FuaXRpemVkTmFtZSA9IGNhbWVsQ2FzZShuYW1lKTtcbiAgcmV0dXJuIGRlZHVwbGljYXRlTmFtZShPYmplY3Qua2V5cyh0b3BMZXZlbENvbmZpZyksIHNhbml0aXplZE5hbWUpO1xufVxuXG5mdW5jdGlvbiBkZWR1cGxpY2F0ZU5hbWUoZXhpc3RpbmdOYW1lczogc3RyaW5nW10sIG5hbWU6IHN0cmluZykge1xuICBsZXQgbmV3TmFtZSA9IG5hbWU7XG4gIGxldCBpID0gMTtcbiAgd2hpbGUgKGV4aXN0aW5nTmFtZXMuaW5jbHVkZXMobmV3TmFtZSkpIHtcbiAgICBuZXdOYW1lID0gYCR7bmFtZX0ke2l9YDtcbiAgICBpKys7XG4gIH1cbiAgcmV0dXJuIG5ld05hbWU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmaWxsV2l0aENvbmZpZ0FjY2Vzc29ycyhcbiAgc2NvcGU6IFJlc291cmNlU2NvcGUsXG4gIGNvbmZpZzogVGVycmFmb3JtUmVzb3VyY2VCbG9jayxcbiAgcGF0aDogc3RyaW5nXG4pOiBhbnkge1xuICBpZiAoQXJyYXkuaXNBcnJheShjb25maWcpKSB7XG4gICAgcmV0dXJuIGNvbmZpZy5tYXAoKGMpID0+IGZpbGxXaXRoQ29uZmlnQWNjZXNzb3JzKHNjb3BlLCBjLCBgJHtwYXRofS5bXWApKTtcbiAgfVxuXG4gIGlmICh0eXBlb2YgY29uZmlnID09PSBcIm9iamVjdFwiICYmIGNvbmZpZyAhPT0gbnVsbCkge1xuICAgIGNvbnN0IG11dGF0ZWQgPSBPYmplY3QuZW50cmllcyhjb25maWcpLnJlZHVjZShcbiAgICAgIChhY2MsIFtrZXksIHZhbHVlXSkgPT4gKHtcbiAgICAgICAgLi4uYWNjLFxuICAgICAgICBba2V5XTogZmlsbFdpdGhDb25maWdBY2Nlc3NvcnMoc2NvcGUsIHZhbHVlLCBgJHtwYXRofS4ke2tleX1gKSxcbiAgICAgIH0pLFxuICAgICAge30gYXMgUmVjb3JkPHN0cmluZywgVGVycmFmb3JtUmVzb3VyY2VCbG9jaz5cbiAgICApO1xuXG4gICAgLy8gR2V0IHR5cGUgb2YgdGhpcyBwYXJ0IG9mIHRoZSBjb25maWdcbiAgICBjb25zdCBhdHRyaWJ1dGVUeXBlID0gZ2V0VHlwZUF0UGF0aChzY29wZS5wcm92aWRlclNjaGVtYSwgcGF0aCk7XG4gICAgY29uc3QgcmVxdWlyZWRBdHRyaWJ1dGVzID0gZ2V0UmVxdWlyZWRBdHRyaWJ1dGVzKGF0dHJpYnV0ZVR5cGUpO1xuXG4gICAgLy8gQWRkIGFjY2Vzc29ycyBmb3IgYWxsIHJlcXVpcmVkIGF0dHJpYnV0ZXMgdGhhdCBhcmUgbWlzc2luZ1xuICAgIHJlcXVpcmVkQXR0cmlidXRlcy5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgIGNvbnN0IHZhbHVlID0gbXV0YXRlZFtrZXldO1xuICAgICAgY29uc3QgaXNOb3REaXJlY3RseUFjY2Vzc2libGUgPSB2YWx1ZSA9PT0gdW5kZWZpbmVkO1xuICAgICAgY29uc3QgaXNSZXBsYWNlZEJ5QXN0ID1cbiAgICAgICAgdC5pc0V4cHJlc3Npb24obXV0YXRlZCkgfHwgdC5pc0V4cHJlc3Npb24odmFsdWUgYXMgYW55KTtcbiAgICAgIGNvbnN0IGlzRW1wdHlBcnJheSA9IEFycmF5LmlzQXJyYXkodmFsdWUpICYmIHZhbHVlLmxlbmd0aCA9PT0gMDtcblxuICAgICAgLy8gSWYgdGhpcyB3YXMgYWxyZWFkeSByZXBsYWNlZCBieSBhbiBBU1Qgbm9kZSwgd2UgZG9uJ3QgbmVlZCB0byBkbyBhbnl0aGluZ1xuICAgICAgLy8gV2UgYXNzdW1lIGFsbCBmaWVsZHMgYXJlIGZpbGxlZCBpbiBieSB0aGUgQVNUXG4gICAgICBpZiAoaXNSZXBsYWNlZEJ5QXN0KSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgaWYgKGlzTm90RGlyZWN0bHlBY2Nlc3NpYmxlIHx8IGlzRW1wdHlBcnJheSkge1xuICAgICAgICBjb25zdCBmaWVsZE5hbWUgPSBnZXRDb25maWdGaWVsZE5hbWUoc2NvcGUudG9wTGV2ZWxDb25maWcsIGtleSk7XG4gICAgICAgIG11dGF0ZWRba2V5XSA9IHQubWVtYmVyRXhwcmVzc2lvbihcbiAgICAgICAgICB0LmlkZW50aWZpZXIoXCJjb25maWdcIiksXG4gICAgICAgICAgdC5pZGVudGlmaWVyKGZpZWxkTmFtZSlcbiAgICAgICAgKTtcbiAgICAgICAgc2NvcGUudG9wTGV2ZWxDb25maWdbZmllbGROYW1lXSA9IGAke3BhdGh9LiR7a2V5fWA7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4gbXV0YXRlZDtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gY29uZmlnO1xuICB9XG59XG5cbnR5cGUgS2V5ID0gc3RyaW5nO1xuZXhwb3J0IGZ1bmN0aW9uIGdldFJlcXVpcmVkQXR0cmlidXRlcyhcbiAgYXR0cmlidXRlVHlwZTogUmV0dXJuVHlwZTx0eXBlb2YgZ2V0VHlwZUF0UGF0aD5cbik6IEtleVtdIHtcbiAgaWYgKCFhdHRyaWJ1dGVUeXBlKSB7XG4gICAgcmV0dXJuIFtdO1xuICB9XG4gIGlmIChcbiAgICB0eXBlb2YgYXR0cmlidXRlVHlwZSAhPT0gXCJvYmplY3RcIiB8fFxuICAgIEFycmF5LmlzQXJyYXkoYXR0cmlidXRlVHlwZSkgfHxcbiAgICBhdHRyaWJ1dGVUeXBlID09PSBudWxsIHx8XG4gICAgYXR0cmlidXRlVHlwZSA9PT0gdW5kZWZpbmVkIHx8XG4gICAgIShcImJsb2NrXCIgaW4gYXR0cmlidXRlVHlwZSlcbiAgKSB7XG4gICAgcmV0dXJuIFtdO1xuICB9XG5cbiAgY29uc3QgcmVxdWlyZWRBdHRyaWJ1dGVzID0gT2JqZWN0LmVudHJpZXMoXG4gICAgYXR0cmlidXRlVHlwZS5ibG9jay5hdHRyaWJ1dGVzIHx8IHt9XG4gICkucmVkdWNlKFxuICAgIChhY2MsIFtrZXksIHZhbHVlXSkgPT4gKHZhbHVlLnJlcXVpcmVkID8gWy4uLmFjYywga2V5XSA6IGFjYyksXG4gICAgW10gYXMgc3RyaW5nW11cbiAgKTtcblxuICAvLyBMb2dpYyB0YWtlbiBmcm9tIChhbmQgc2hvdWxkIGJlIHNoYXJlZCB3aXRoKSBwcm92aWRlciBnZW5lcmF0b3IgcmVzb3VyY2UgcGFyc2VyOiBhdHRyaWJ1dGVGb3JCbG9ja1R5cGVcbiAgY29uc3QgcmVxdWlyZWRCbG9ja1R5cGVzID0gT2JqZWN0LmVudHJpZXMoXG4gICAgYXR0cmlidXRlVHlwZS5ibG9jay5ibG9ja190eXBlcyB8fCB7fVxuICApLnJlZHVjZSgoYWNjLCBba2V5LCB2YWx1ZV0pID0+IHtcbiAgICBpZiAoXG4gICAgICB2YWx1ZS5uZXN0aW5nX21vZGUgPT09IFwic2luZ2xlXCIgJiZcbiAgICAgICFPYmplY3QudmFsdWVzKHZhbHVlLmJsb2NrLmF0dHJpYnV0ZXMgfHwge30pLnNvbWUoKHgpID0+ICF4LnJlcXVpcmVkKVxuICAgICkge1xuICAgICAgcmV0dXJuIFsuLi5hY2MsIGtleV07XG4gICAgfVxuICAgIGlmICh2YWx1ZS5uZXN0aW5nX21vZGUgPT09IFwibWFwXCIpIHtcbiAgICAgIHJldHVybiBhY2M7XG4gICAgfVxuXG4gICAgaWYgKFxuICAgICAgKHZhbHVlLm5lc3RpbmdfbW9kZSA9PT0gXCJsaXN0XCIgfHwgdmFsdWUubmVzdGluZ19tb2RlID09PSBcInNldFwiKSAmJlxuICAgICAgdmFsdWUubWluX2l0ZW1zID09PSB1bmRlZmluZWRcbiAgICAgICAgPyBmYWxzZVxuICAgICAgICA6ICh2YWx1ZSBhcyBhbnkpLm1pbl9pdGVtcyA+IDBcbiAgICApIHtcbiAgICAgIHJldHVybiBbLi4uYWNjLCBrZXldO1xuICAgIH1cblxuICAgIHJldHVybiBhY2M7XG4gIH0sIFtdIGFzIHN0cmluZ1tdKTtcbiAgcmV0dXJuIFsuLi5yZXF1aXJlZEF0dHJpYnV0ZXMsIC4uLnJlcXVpcmVkQmxvY2tUeXBlc10uc29ydCgpO1xufVxuIl19